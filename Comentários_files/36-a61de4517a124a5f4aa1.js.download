(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{OsJo:function(e,s,t){"use strict";t.d(s,"a",(function(){return i}));class i{static insertElement(e,s,t,i){const o=`lr_${s}_scope`,a=`lr_${s}_element`;return e&&!e[o]&&(e[o]=e.$new(),t(e[o],(s=>{e[a]=s,i.append(e[a])})),e.$applyAsync()),{childScope:e[o],childElement:e[a]}}static removeElement(e,s){const t=`lr_${s}_scope`,i=`lr_${s}_element`;e&&e[t]&&(e[i].remove(),delete e[i],e[t].$destroy(),delete e[t],e.$applyAsync())}}},Ox3N:function(e,s,t){"use strict";t.d(s,"a",(function(){return r}));var i=t("Llzl"),o=t("1ZbL"),a=t("50Q+"),n=t("0JpG");const r="ultra.components.directives.react-toolkit.linked-username",c={Class:a.e,attributes:["analyticsId","subtext"],bindingNames:["user","format","ariaHidden","showPronouns","showPronunciation","onClick","userNameStyles"],renderLocalized:!0,withProvider:!0,withErrorModalBoundary:!1};i.module(r,[n.moduleName]).component("bbLinkedUsername",Object(o.a)(c))},Sgjf:function(e,s,t){"use strict";var i=t("D57K"),o=(t("ptBS"),t("SSV0"),t("71td")),a=t("Llzl"),n=t("jciN"),r=t("0JpG"),c=t("fYJU"),l=t("pjml"),d=t("+4Px"),u=t("OvxF"),h=t("lUN/"),p=t("TnpK"),m=t("qeC2"),g=t("aHpC"),b=t("nmzr");t.d(s,"a",(function(){return v}));const v="ultra.components.directives.usercard";class y{constructor(e,s,t,i,o,a,n,r,c,l){this.$modal=e,this.$q=s,this.scope=t,this.element=i,this.attrs=o,this.bbLocalize=a,this.CourseModel=n,this.contextUser=r,this.$userModelService=c,this.ultraState=l,this.current=this.contextUser.userModel,null==this.scope.autoUpdate&&(this.scope.autoUpdate=!0),this.scope.showcard=!1,h.a(),this.$userModelService.$mixHook("after-save",(function(){this.id===t.user.id&&(t.userNames={givenName:this.givenName,familyName:this.familyName})}),t)}canSendMessage(){const e=this.scope.canSendMessage;return!e||e()}hasDueDateException(){const e=this.scope.hasDueDateException;return!!e&&e()}canEditDueDateException(){const e=this.scope.canEditDueDateException;return!!e&&e()}sendMessage(){this.ultraState.goPeekState(this.getMessagePeekState(),{courseId:this.scope.courseId,recipientIds:this.scope.user.id})}getMessagePeekState(){return this.scope.messagePeekState||b.o.COURSE_MESSAGE}getUserNameLabel(){return this.userName=this.scope.userNames,this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.usercard.ariaButtonLabel",params:{user:this.userName},noWrap:!0,noEscape:!0})}keyDown(e){if(e.keyCode===d.t&&e.preventDefault(),this.scope.showcard){let s=!1;if(e.keyCode===d.g)s=!0;else if(e.keyCode===d.u){const t=o(".usercard").find(":tabbable");s=t.length<1||(!(!e.shiftKey||!o(".usercard-clickable").is(":focus"))||(e.shiftKey?document.activeElement===t[0]:document.activeElement===t[t.length-1]))}s&&(e.stopImmediatePropagation(),this.hide())}}hide(){this.scope.showcard&&(this.scope.showcard=!1,this.toggleFloatingContainer(),this.element.find(".usercard-trigger").focus())}show(){this.scope.showcard=!!this.canShow(),this.toggleFloatingContainer()}toggleFloatingContainer(){o(".floating-column-container").css("overflow",this.scope.showcard?"visible":"hidden")}canShow(){return!!this.scope.user&&!!this.scope.user.id&&!this.isSameUser()}isSameUser(){return!(!this.current||!this.scope.user)&&this.scope.user.id===this.current.id}getCourseRoleLocalizeId(){return this.scope.inactive&&this.scope.inactive()?this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.usercard.unavailable"}):this.scope.courseRole()}sendMessageViaSpaceBar(e){this.scope.showcard&&e.keyCode===d.t&&(e.stopPropagation(),this.sendMessage())}}y.$inject=["$modal","$q","scope","element","attrs",r.serviceName,l.m.serviceName,c.b,l.Jb.serviceName,p.d],Object(i.a)([Object(g.d)("locale","userNames")],y.prototype,"getUserNameLabel",null);class f{constructor(e,s,t){this.$injector=e,this.bbLocalize=s,this.ultraState=t,this.restrict="E",this.template=m,this.scope={user:"=",panel:"@?",courseId:"@",messagePeekState:"@?",courseRole:"&",usercardShow:"@",recipientIds:"=",canSendMessage:"&?",hasDueDateException:"&?",canEditDueDateException:"&?",isWarningRender:"=?",membershipId:"=?",inactive:"&?",autoUpdate:"=?"},this.link=(e,s,t)=>{e.attr=t,e.bbUsercard=this.$injector.instantiate(y,{scope:e,element:s,attrs:t}),e.user&&(e.userName=this.bbLocalize.formatUsernameSync(e.user,r.ILocaleUsernameFormat.Short,e,{noWrap:!0,noEscape:!0}),e.userNames=e.user)}}}f.$inject=["$injector",r.serviceName],a.module(v,[n.a,r.moduleName,l.N,c.a,u.a,p.b]).directive("bbUsercard",["$injector",e=>e.instantiate(f)])},ap1t:function(e,s,t){"use strict";var i=t("D57K"),o=t("Llzl"),a=t("nsO7"),n=t("d8yC"),r=t("en1n"),c=t("0JpG"),l=t("Fvsw"),d=t("X/qj"),u=t("yMoE"),h=t("pjml"),p=t("TnpK"),m=t("g66W"),g=t("fYJU"),b=t("ooAF"),v=t("nmzr"),y=t("zGdY"),f=t("aHpC"),w=t("qH3X");t.d(s,"a",(function(){return S}));const S="ultra.components.directives.grade.displayGradePill",C="--",I="na";let E=class{constructor(e,s,t,i,o,a,n,c,l){this.$injector=e,this.$sce=s,this.scope=t,this.element=i,this.bbLocalize=o,this.context=a,this.ultraState=n,this.gradebookPermissionService=c,this.contextUser=l;const d=this.scope.column()&&this.scope.column().courseId;this.bundlePromise=o.loadBundle("components/directives/grade/display-grade"),this.canViewGradebook=this.hasViewGradebook(d),this.isStudent=l.userModel.isStudent(),this.isInstructor=l.userModel.isInstructor(),this.canViewGrades=this.hasViewGrades(d),this.canViewGrades?(this.scope.$watch("::column()",(e=>{if(e){this.scope.$watchGroup(["column()","attempt()","grade()"],(()=>{this.scope.grade&&this.scope.grade();this.createGradeDisplayItem(this.scope).then((e=>{this.gradeDisplayItem=e,this.setFullDisplayValue()}))}))}})),this.scope.$watch((()=>r.g()),(()=>{this.displayValue&&this.setFullDisplayValue()}))):this.displayValue=C,t.$on(w.a.REFRESH_OVERALL_EDITOR,(()=>{this.gradeDisplayItem.displayValue||this.shouldShowPendingForGrade()||this.shouldShowPendingForAttempt()||this.setNoSubmitView()}))}hasViewGradebook(e){return this.gradebookPermissionService.canView(e)}hasViewGrades(e){return this.isStudent||this.gradebookPermissionService.canViewGrades(e)}shouldShowPendingForGrade(){const e=this.scope.grade;return e&&e()&&!e().isPosted()&&e().hasAttempts()}shouldShowPendingForAttempt(){const e=this.scope.attempt;return e&&e()&&e().isNeedsGrading()}shouldRenderInlineRubric(){const e=this.scope.grade;return this.rubricEvaluationIsComplete()||this.shouldShowPendingForGrade()||this.shouldShowPendingForAttempt()||e().isPastDueZero()}shouldShowExempt(){var e;const s=this.scope.grade;return!!(null===(e=null==s?void 0:s())||void 0===e?void 0:e.isExempt)}isCurrentUserGrader(){return this.contextUser.userModel.memberships.every((e=>e.role===y.V.Grader))}setNoSubmitView(){this.schema&&this.scaleType&&(this.scaleType===y.ac.Percent?this.displayValue="-- %":this.scaleType!==y.ac.Score||this.shouldShowExempt()?this.displayValue=C:this.bundlePromise.then((()=>{var e,s,t,i,o,a;const r=null===(e=this.scope)||void 0===e?void 0:e.grade(),c=null!=(null==r?void 0:r.manualGrade)?r.pointsPossible:null===(t=null===(s=this.scope)||void 0===s?void 0:s.column())||void 0===t?void 0:t.possible,l=null!==(a=null!=c?c:null===(o=null===(i=this.scope)||void 0===i?void 0:i.column())||void 0===o?void 0:o.possible)&&void 0!==a?a:0;this.displayValue=C+this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.grade.display-grade.total",params:{total:n.b(l,2)},noWrap:!0})})))}get colorClass(){return this.canViewGrades?this.gradeDisplayItem?this.gradeDisplayItem.displayValue||this.shouldShowExempt()?this.gradeDisplayItem.getGradeColor():this.isStudent?this.shouldShowPendingForGrade()||this.shouldShowPendingForAttempt()?"na pending":"na no-attempt":"":"":I}setFullDisplayValue(){if(this.displayValue=this.gradeDisplayItem&&this.gradeDisplayItem.displayValue,this.gradeDisplayItem.displayValue)this.shouldShowPossiblePoints()&&this.isSchemaTypeScore()?this.bundlePromise.then((()=>{this.displayValue=this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.grade.display-grade.score",params:{grade:this.gradeDisplayItem.displayValue,possible:n.b(this.scope.grade&&this.scope.grade().pointsPossible||this.scope.column().possible,2)},noWrap:!0,noEscape:!0})})):this.isDiscussionOrJournal()||this.isSchemaTypeLetterOrPercentage()?this.displayValue=this.shouldShowPossiblePoints()||!this.shouldShowExempt()||this.isSchemaTypeLetterOrPercentage()?this.gradeDisplayItem.displayValue:C:this.displayValue=this.shouldShowExempt()&&!this.scope.column().isScorm()?C:this.gradeDisplayItem.displayValue;else if(this.shouldShowExempt())this.displayValue=C;else if(this.isStudent&&(this.shouldShowPendingForGrade()||this.shouldShowPendingForAttempt()))this.bundlePromise.then((()=>{this.displayValue=this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.grade.display-grade.pending-grade",noWrap:!0})}));else{this.shouldShowExempt()&&this.gradeDisplayItem.getGradeColor();this.setNoSubmitView()}}get isStacked(){return!!this.scope.displayStacked}get cursorClass(){return this.scope.cursor?`cursor-${this.scope.cursor}`:""}isSchemaTypeLetterOrPercentage(){return this.scaleType===y.ac.Percent||this.scaleType===y.ac.Tabular}isSchemaTypeScore(){return this.scaleType===y.ac.Score}isDiscussionOrJournal(){return this.scope.column().isDiscussion()||this.scope.column().isJournal()}shouldShowPossiblePoints(){var e,s,t,i;return this.shouldShowExempt()?(null===(s=null===(e=this.scope.grade())||void 0===e?void 0:e.displayGrade)||void 0===s?void 0:s.isOverride)||(null===(i=null===(t=this.scope.grade())||void 0===t?void 0:t.displayGrade)||void 0===i?void 0:i.scoredByAutomaticZero)||this.gradeDisplayItem.shouldShowTotalPoints():!this.isSmallBP()&&this.gradeDisplayItem&&!a.isNaN(parseFloat(this.gradeDisplayItem.displayValue))&&this.gradeDisplayItem.shouldShowTotalPoints()}isSmallBP(){return r.a.Small===r.f()}shouldShowRubricButton(){var e,s,t;return!(this.scope.hideRubricIcon||!this.scope.column()||!this.scope.column().hasRubricAssociation())&&(!!this.isDiscussionOrJournal()||(null!=this.scope.attempt||!(!this.scope.column().isSingleAttempt()||y.l.InProgress===(null===(t=null===(s=null===(e=this.scope.grade())||void 0===e?void 0:e.ui)||void 0===s?void 0:s.attempt)||void 0===t?void 0:t.status))))}rubricEvaluationIsComplete(){const e=this.scope.column();if(e&&e.hasRubricAssociation()){const s=this.scope.attempt?this.scope.attempt():this.scope.grade().ui.attempt;return e.getRubricAssociation().isWithEvaluations&&(s&&s.isCompleted()||e.isDiscussion()||e.isJournal())}return!1}openRubricEvaluation(e){if(this.scope.disableRubricEvalClick&&this.scope.disableRubricEvalClick())return;e.stopPropagation();const s=this.getRubricStateRef();this.ultraState.current.name.endsWith("peek.assessment-submission-feedback")&&this.ultraState.leavePeekState(this.ultraState.current.name),this.ultraState.goPeekState(s.state,s.args)}getRubricStateRef(){var e;let s,t;(this.scope.grade||this.scope.attempt)&&(this.scope.attempt&&(s=null!==(e=this.scope.attempt().groupAttemptId)&&void 0!==e?e:this.scope.attempt().id),this.scope.grade&&this.scope.grade().ui&&this.scope.grade().ui.attempt&&this.scope.grade().ui.attempt.id&&(s=this.scope.grade().ui.attempt.id||this.scope.grade().ui.attempt.groupAttemptId),t=this.scope.attempt?this.scope.attempt().groupId:null,this.scope.grade&&this.scope.grade().ui.groupAttempt&&(t=this.scope.grade().ui.groupAttempt.groupId));const i={state:"",args:{attemptId:s||null,columnId:this.scope.column().id||null,contentId:this.scope.column().contentId||null,courseId:this.scope.column().courseId}};let o="inline-rubric";if(this.scope.isManualStatusPosted||this.gradeDisplayItem.displayValue&&"0"!==this.gradeDisplayItem.displayValue||this.scope.isExternalSubmission||this.scope.column().isCollectExternalSubmissions()||(o=this.shouldRenderInlineRubric()?"inline-rubric":"peek.rubric-view"),this.canViewGradebook||this.isDiscussionOrJournal()){const e=this.rubricEvaluationIsComplete()?"rubric-evaluation":"rubric-view";i.args.groupId=t||null,i.args.userId=this.scope.grade&&this.scope.grade().user&&(this.scope.grade().user.$pk||this.scope.grade().user.id)||null,i.state=e,this.scope.column().isJournal()&&(i.state=this.rubricEvaluationIsComplete()?v.B.JOURNAL_VIEW_WITH_PARTICIPATION_AND_RUBRIC_EVALUATION:v.B.JOURNAL_VIEW_WITH_PARTICIPATION_AND_RUBRIC_VIEW)}else i.args.groupId=t||null,i.state=`${v.c.ASSESSMENT_ATTEMPT_REVIEW}.${o}`;return m.d(this.ultraState.current.name,".peek.course.grades")&&(this.scope.column().isCollectExternalSubmissions()?(i.state=`${v.c.ASSESSMENT_ATTEMPT_REVIEW}.inline-rubric`,i.args.skipTransitionEvents=!0):i.state="assessment.overview"),i}createGradeDisplayItem(e){const s=this.scope.grade&&this.scope.grade(),t=this.$injector.instantiate(u.a,{gradeDetail:s,scope:e});return t.init(this.scope.column()).then((()=>{let e;return this.schema=t.schema,this.schema&&(this.scaleType=t.schema.scaleType),this.scope.attempt?e=this.scope.attempt().displayGrade:s&&this.schema&&(e=s.displayGrade),t.displayGrade=e,t}))}};E=Object(i.a)([Object(i.c)(0,Object(f.b)("$injector")),Object(i.c)(1,Object(f.b)("$sce")),Object(i.c)(2,Object(f.b)("scope")),Object(i.c)(3,Object(f.b)("element")),Object(i.c)(4,Object(f.b)(c.serviceName)),Object(i.c)(5,Object(f.b)(l.b)),Object(i.c)(6,Object(f.b)(p.d)),Object(i.c)(7,Object(f.b)(d.b)),Object(i.c)(8,Object(f.b)(g.b))],E);class O{constructor(e){this.$injector=e,this.restrict="E",this.template=b,this.scope={attempt:"&?",column:"&",disableRubricEvalClick:"&?",grade:"&?",isManualStatusPosted:"<?",cursor:"@?",hideRubricIcon:"=?",isExternalSubmission:"=?",rubricStateOverride:"@?",displayStacked:"@?"},this.link=(e,s)=>{if(!e.attempt&&!e.grade)throw new Error("An attempt or grade must be included on scope");if(e.attempt&&e.grade)throw new Error("An attempt or grade should be included on scope, not both");if(!e.column)throw new Error("A column must be included on scope");e.displayGradePill=this.$injector.instantiate(E,{scope:e,element:s})}}}O.$inject=["$injector"],o.module(S,[h.N,d.a]).directive("bbDisplayGradePill",["$injector",e=>e.instantiate(O)])},e9p2:function(e,s,t){"use strict";var i=t("ERsv");s.a={generateToBbML:i.generateToBbML,isMessageTooLong:i.isMessageTooLong}},h7qX:function(e,s,t){"use strict";(function(e){t.d(s,"d",(function(){return a})),t.d(s,"a",(function(){return n})),t.d(s,"b",(function(){return r})),t.d(s,"c",(function(){return c}));var i=t("Llzl"),o=t("nsO7");const a="ultra.components.directives.intersectionObserverRoot",n="intersection-observer-target-id",r="intersectionObserverTargetId";class c{constructor(e,s=i.noop,t=i.noop){this.element=e,this.inCallback=s,this.outCallback=t}getId(){return this.element.attr(n)}in(){this.inCallback()}out(){this.outCallback()}toElement(){return this.element.get(0)}}class l{constructor(s){this.targets=new Map,this.intersectionObserver=new IntersectionObserver((s=>{s.forEach((s=>{const t=this.targets.get(e(s.target).attr(n));t&&(s.isIntersecting?t.in():t.out())}))}),s)}observe(e){const s=e.getId();o.isEmpty(s)||(this.unobserve(s),this.targets.set(s,e),this.intersectionObserver.observe(e.toElement()))}unobserve(e){if(o.isEmpty(e))return;const s=this.targets.get(e);s&&(this.intersectionObserver.unobserve(s.toElement()),this.targets.delete(e))}disconnect(){this.intersectionObserver.disconnect(),this.targets.clear()}}class d{constructor(e,s){this.$scope=e,this.$element=s;const t=(e.rootOptions||(()=>({root:s.get(0),rootMargin:"0px 0px 0px 0px"})))();this.observer=new l(t),e.$on("$destroy",(()=>this.unregisterAll()))}registerTarget(e){this.observer.observe(e)}unregisterTarget(e){this.observer.unobserve(e.getId())}unregisterAll(){this.observer.disconnect()}}d.$inject=["$scope","$element"];class u{constructor(){this.restrict="A",this.scope={rootOptions:"&?"},this.controller=d}}i.module(a,[]).directive("bbIntersectionObserverRoot",["$injector",e=>e.instantiate(u)])}).call(this,t("71td"))},jbaE:function(e,s,t){"use strict";(function(e){t.d(s,"a",(function(){return C}));var i=t("D57K"),o=(t("ph44"),t("vhkR")),a=t("cs5G"),n=t("Llzl"),r=t("Fvsw"),c=t("Qbdf"),l=t("0JpG"),d=t("X8JP"),u=t("9hVN"),h=t("TnpK"),p=t("ohO4"),m=t("jx5I"),g=t("5MwF"),b=t("ERsv"),v=t("Q/M7"),y=t("pjml"),f=t("Y+9S"),w=t("aHpC"),S=t("x2Ev");const C="ultraUi.components.directives.editor.richTextEditor";let I=class{constructor(e,s,t,i,o,a,n,r,c,l,d,u,h,p,m,g,b){this.$q=e,this.$scope=s,this.element=t,this.attrs=i,this.controllers=o,this.bbEditorFactory=a,this.bbLocalize=n,this.bbContext=r,this.ltiService=c,this.CloudStorageIntegrationModalService=l,this.ContentCollectionService=d,this.AnnotationsModel=u,this.contextCourse=h,this.allyService=p,this.ultraState=m,this.featureFlagService=g,this.fileUploadSettingsService=b;const v=this.$scope.$watch("pluginOptions",(e=>{e&&(v(),this.initEditor())}));this.reactAllyService=this.allyService.getReactService(this.$scope),s.$on("$destroy",(()=>{s.editor&&s.editor.destroy()}))}initEditor(){let e=null,s=!1,t=null;const i=this.controllers.ngModel,o=i.$setPristine.bind(i);i.$viewChangeListeners.push((()=>{s||o()})),i.$setPristine=()=>{o(),t&&t(i.$modelValue)};const a=e=>{this.$scope.editor&&this.$scope.editor.update(e)};this.$scope.$watch((()=>i.$modelValue),(s=>{s!==e&&a({bbml:s})})),this.$scope.$watchGroup(["isDisabled","isReadOnly","isToolbarHidden","allyIndexMap"],(([e,s,t,i])=>{this.$scope.editor&&a({isDisabled:e,isReadOnly:s,isToolbarHidden:t,ally:{service:this.reactAllyService,indexMap:i}})}));const n=(e,s)=>void 0!==e?e:s,r=e=>{this.$scope.fileLocation=e.data?e.data.fileLocation:e.fileLocation,this.$scope.webLocation=e.data?e.data.webLocation:e.webLocation},c=o=>{var a,n;s=o.isDirty,t=o.setPristine;const r=o.toBbML();e!==r&&(e=r,null===(n=(a=this.$scope).onChange)||void 0===n||n.call(a,o.toBbML),i.$setViewValue(r))},l={placeholderText:this.bbLocalize.translate({locale:this.bbLocalize.getLocale(this.$scope),key:this.$scope.placeholder})};this.$scope.pluginOptions&&this.$scope.pluginOptions.attachment&&(l.cloudStorageIntegration=this.CloudStorageIntegrationModalService.initialize()),l.inlineRenderFfEnabled=this.featureFlagService.createWaiter("feature.course.content.inline-render"),this.$q.all(l).then((e=>{const s=[Object(b.customClass)()],{locale:t,babelfishInstance:o,babelfishFormatter:a,isRtl:l}=this.bbLocalize.getReactBabelfishParams(this.$scope);if(this.$scope.pluginOptions){!1!==this.$scope.pluginOptions.link&&s.push(Object(b.link)()),!1!==this.$scope.pluginOptions.image&&s.push(Object(b.image)()),!1!==this.$scope.pluginOptions.video&&s.push(Object(b.video)()),this.$scope.pluginOptions.math&&s.push(Object(b.math)({apiBasePath:Object(v.c)(g.a.apiBasePath),courseId:this.contextCourse.courseId,xsrfToken:this.bbContext.xsrfToken,locale:t})),this.$scope.pluginOptions.attachment&&s.push(Object(b.insertLocalFile)({apiBasePath:Object(v.c)(g.a.apiBasePath),xsrfToken:this.bbContext.xsrfToken,webLocation:this.$scope.webLocation||"",fileLocation:this.$scope.fileLocation||"",onUploadSuccess:r,buttonId:Object(f.m)()?"insertFile":"",supportsInlineDocumentRender:this.$scope.supportsInlineDocumentRender&&e.inlineRenderFfEnabled,fileUploadSettings:this.fileUploadSettingsService.getSettings(),onNewAttachmentSavePressed:this.$scope.onNewAttachmentSavePressed,courseId:this.contextCourse.courseId}));let i=!0;!1===this.$scope.pluginOptions.youtubeVideo&&(i=!1),i&&s.push(Object(b.insertYoutubeVideo)({apiBasePath:Object(v.c)(g.a.apiBasePath),getEmbedSrc:this.ltiService.configureAndInitInlineLaunch.bind(this.ltiService),xsrfToken:this.bbContext.xsrfToken,courseId:this.contextCourse.courseId})),this.$scope.pluginOptions.demoMashup&&s.push(Object(b.demoMashup)()),this.$scope.pluginOptions.attachment&&this.CloudStorageIntegrationModalService.isCloudServiceAvailable&&!Object(f.m)()&&s.push(Object(b.insertCloudStorageIntegrationFile)({openCloudStorageIntegrationModal:this.CloudStorageIntegrationModalService.getModalCallback(this.$scope),apiBasePath:Object(v.c)(g.a.apiBasePath),xsrfToken:this.bbContext.xsrfToken,webLocation:this.$scope.webLocation||"",fileLocation:this.$scope.fileLocation||"",fileUploadSettings:this.fileUploadSettingsService.getSettings(),onNewAttachmentSavePressed:this.$scope.onNewAttachmentSavePressed})),this.$scope.pluginOptions.contentCollection&&s.push(Object(b.contentCollection)({getOpenContentCollectionFunction:this.ContentCollectionService.getOpenContentCollectionFunction(this.$scope)})),this.$scope.pluginOptions.contentMarket&&s.push(Object(b.contentMarket)({apiBasePath:Object(v.c)(g.a.apiBasePath),getEmbedSrc:this.ltiService.configureAndInitInlineLaunch.bind(this.ltiService),noInsert:this.$scope.contentMarketIsReadOnly,openContentMarket:this.ltiService.getOpenContentMarketConf(this.$scope),xsrfToken:this.bbContext.xsrfToken}))}let d=this.$scope.rootContentId;!d&&this.ultraState&&this.ultraState.getCurrentResolvedValues&&this.ultraState.getCurrentResolvedValues().currentContent&&(d=this.ultraState.getCurrentResolvedValues().currentContent.id);const u={bbml:i.$modelValue||"",isDisabled:n(this.$scope.isDisabled,!1),isReadOnly:n(this.$scope.isReadOnly,!1),isToolbarHidden:n(this.$scope.isToolbarHidden,!1),isRtl:l,locale:t,expandInlineFilesOnLoad:this.$scope.expandInlineFilesOnLoad,supportsInlineDocumentRender:this.$scope.supportsInlineDocumentRender&&e.inlineRenderFfEnabled,babelfishInstance:o,babelfishFormatInstance:a,onChange:c,placeholder:e.placeholderText,plugins:s,editorId:this.$scope.editorId,ariaLabelledBy:this.$scope.editorAriaLabelledBy,ariaDescribedBy:this.$scope.editorAriaDescribedBy,showWordCount:this.$scope.showWordCount,ally:{service:this.reactAllyService,indexMap:this.$scope.allyIndexMap||new Map},rootContentId:d,...this.$scope.onFocus?{onFocus:()=>this.$scope.$applyAsync(this.$scope.onFocus)}:null,...this.$scope.onBlur?{onBlur:()=>this.$scope.$applyAsync(this.$scope.onBlur)}:null,...g.a.unitTesting?{mockLocalize:Object(S.a)()}:null};this.$scope.onBlur&&i.$setTouched(),this.$scope.editor=this.bbEditorFactory(this.element[0],u)}))}getOnDownloadWithAnnotations(){return s=>{const t=!!s.groupAttemptFileId,i=s.attemptFileId||s.groupAttemptFileId,o={systemInfo:this.bbContext.getSystemInfo().$asPromise(),annotations:this.AnnotationsModel.downloadWithAnnotations(i,t,this.contextCourse.courseId).$asPromise()};return this.$q.all(o).then((s=>{const t=s.systemInfo.annotationRendererUrl;if(!(t&&t.length>0))throw new Error("Annotation Service url is not defined.");{const i=e("#annotationIframe");null!==i&&i.remove();const o=e("#annotationForm");null!==o&&o.remove();const a=e(document.createElement("iframe"));a.attr("src","about:blank"),a.attr("id","annotationIframe"),a.attr("name","annotationIframe"),a.css("display","none");const n=e(document.createElement("form"));n.attr("target","annotationIframe"),n.attr("method","POST"),n.attr("action",t+"/annotation/token"),n.attr("id","annotationForm"),n.attr("name","annotationForm");const r=e(document.createElement("input"));r.attr("type","hidden"),r.attr("name","jwt"),r.attr("value",s.annotations.jwt),r.appendTo(n);const c=e("body");n.appendTo(c),a.appendTo(c),n.submit()}}))}}};I=Object(i.a)([Object(i.c)(0,Object(w.b)("$q")),Object(i.c)(1,Object(w.b)("scope")),Object(i.c)(2,Object(w.b)("element")),Object(i.c)(3,Object(w.b)("attrs")),Object(i.c)(4,Object(w.b)("controllers")),Object(i.c)(5,Object(w.b)("BbEditorFactory")),Object(i.c)(6,Object(w.b)(l.serviceName)),Object(i.c)(7,Object(w.b)(r.b)),Object(i.c)(8,Object(w.b)(o.b)),Object(i.c)(9,Object(w.b)(d.b)),Object(i.c)(10,Object(w.b)(u.b)),Object(i.c)(11,Object(w.b)(y.c.serviceName)),Object(i.c)(12,Object(w.b)(c.e)),Object(i.c)(13,Object(w.b)(a.b)),Object(i.c)(14,Object(w.b)(h.d)),Object(i.c)(15,Object(w.b)(p.b)),Object(i.c)(16,Object(w.b)(m.b))],I);class E{constructor(e){this.$injector=e,this.link=(e,s,t,i)=>{s.addClass("rich-text-editor"),e.richTextEditor=this.$injector.instantiate(I,{scope:e,element:s,attrs:t,controllers:i})},this.require={ngModel:"ngModel"},this.restrict="E",this.scope={contentMarketIsReadOnly:"<?",fileLocation:"=?",isDisabled:"<?",isReadOnly:"<?",isToolbarHidden:"<?",onChange:"<?",onBlur:"&?",onNewAttachmentSavePressed:"&?",onFocus:"&?",placeholder:"@?editorPlaceholderKey",pluginOptions:"<?",webLocation:"=?",editorId:"@?",editorAriaLabelledBy:"@?",editorAriaDescribedBy:"@?",showWordCount:"<?",allyIndexMap:"=?",rootContentId:"@?",expandInlineFilesOnLoad:"<?",supportsInlineDocumentRender:"<?"}}}E.$inject=["$injector"],n.module(C,[l.moduleName,r.a,d.a,u.a,o.a,a.a,m.a]).value("BbEditorFactory",b.BbEditorFactory).directive("bbRichTextEditor",["$injector",e=>e.instantiate(E)])}).call(this,t("71td"))},jmkQ:function(e,s,t){"use strict";t.d(s,"a",(function(){return n}));var i=t("Llzl"),o=t("nsO7"),a=t("h7qX");const n="ultra.components.directives.intersectionObserverTarget";class r{constructor(){this.require="^^bbIntersectionObserverRoot",this.restrict="A",this.scope={[a.b]:"@",inCallback:"&?",outCallback:"&?"},this.link=(e,s,t,i)=>{o.isEmpty(e[a.b])||(s.attr(a.a,e[a.b]),e.target=new a.c(s,e.inCallback,e.outCallback),i.registerTarget(e.target),e.$on("$destroy",(()=>{i.unregisterTarget(e.target)})))}}}i.module(n,[]).directive("bbIntersectionObserverTarget",["$injector",e=>e.instantiate(r)])},k6nO:function(e,s,t){var i=t("ziER"),o=t("5JeM"),a=new i({id:"icon-medium-trash",use:"icon-medium-trash-usage",viewBox:"0 0 24 24",content:'<symbol fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-medium-trash"><path d="M3.5 7h17M3 4l2 19h14l2-19M8 4V1h8v3M2 4h20M8 10l1 10M12 10v10M16 10l-1 10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></symbol>'});o.add(a);e.exports=a},ooAF:function(e,s){e.exports='<div class="grade-color" ng-class="{\'flex-column\': displayGradePill.isStacked}">\n    <div class="wrapping-input-style readonly pill-style {{displayGradePill.colorClass}} {{displayGradePill.cursorClass}}">\n      <div ng-if="!displayGradePill.shouldShowRubricButton()">\n        <span class="grade-input-display grade-ellipsis"><bdi>{{displayGradePill.displayValue}}</bdi></span>\n      </div>\n      <div ng-if="displayGradePill.shouldShowRubricButton()">\n        <a ng-click="displayGradePill.openRubricEvaluation($event)"\n           ng-class="{\'disable-click\': !!disableRubricEvalClick()}"\n           class="grade-rubric-detail"\n           aria-disabled="{{!!disableRubricEvalClick()}}"\n           href=""\n           analytics-id="components.directives.grade.gradePill.showRubric.link">\n          <bb-svg-icon size="small" icon="rubric"></bb-svg-icon>\n          <span class="grade-input-display ready grade-ellipsis">{{displayGradePill.displayValue}}</span>\n        </a>\n      </div>\n    </div>\n    <div ng-if="displayGradePill.shouldShowExempt()" class="left">\n      <span class="exempt-indicator" bb-translate>components.directives.grade.grade-input.exempt</span>\n    </div>\n</div>\n'},pSe1:function(e,s){e.exports='<bb-usercard usercard-show="avatar"\n  user="::message.user"\n  course-id="{{::courseId}}"\n  can-send-message="::messageControl.canSendMessageInUserCard()"\n  course-role="::messageControl.scope.courseRole"\n  auto-update="false"\n  inactive="!messageControl.isAvailable()">\n</bb-usercard>\n'},ph44:function(e,s,t){},ptBS:function(e,s,t){var i=t("ziER"),o=t("5JeM"),a=new i({id:"icon-medium-messages",use:"icon-medium-messages-usage",viewBox:"0 0 24 24",content:'<symbol fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-medium-messages"><path d="M1 4v16h22V4H1z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M1 4l8.4419 7.6744L12 14l2.5581-2.3256L23 4M23 20c-3.3676-3.5207-5.5754-5.3288-8.4418-8.3256M1 20l8.4419-8.3256" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></symbol>'});o.add(a);e.exports=a},qeC2:function(e,s){e.exports='<div bb-load-bundle="components/directives/usercard" bb-cache-compilation="user-card" title="{{::userName}}">\n\n    <div ng-if="user.ui.anonymousStudent" class="anonymous-student-avatar">\n      <bb-avatar user="user" role="presentation" auto-update="::autoUpdate" inactive="inactive()"></bb-avatar>\n    </div>\n\n    <div ng-if="!user.ui.anonymousStudent"\n         ng-click="bbUsercard.show()"\n         ng-keydown="bbUsercard.keyDown($event)"\n         ng-mouseleave="bbUsercard.hide()"\n         tabindex="{{::bbUsercard.canShow() ? 0 : -1}}"\n         class="usercard-trigger"\n         ng-class="::{\'usercard-clickable\': bbUsercard.canShow(), \'usercard-not-clickable\': !bbUsercard.canShow()}"\n         role="button"\n         aria-expanded="{{showcard}}"\n         analytics-id="components.directives.usercard.showCard"\n    >\n        <div ng-switch="usercardShow" tabindex="-1">\n            <span ng-switch-when="username" class="usercard-button">\n                <bb-username class="name-title" user="user" ng-attr-format="{{attr.format}}" auto-update="{{autoUpdate}}" show-pronouns="true"\n                             ng-class="{ inactive: inactive() }"></bb-username>\n            </span>\n            <span ng-switch-when="avatar" class="usercard-button">\n                <bb-avatar user="user" role="presentation" auto-update="::autoUpdate"\n                  inactive="inactive()" is-warning-render="isWarningRender"></bb-avatar>\n            </span>\n            <span ng-switch-when="combined" class="usercard-button">\n              <bb-avatar user="user" role="presentation" auto-update="::autoUpdate" inactive="inactive()"></bb-avatar>\n              <bb-username user="user" format="short" auto-update="::autoUpdate" show-pronouns="true" ng-class="{ inactive: inactive() }"></bb-username>\n            </span>\n            <span ng-switch-when="outline" class="usercard-button">\n                <bb-avatar user="user" role="presentation" auto-update="::autoUpdate" inactive="inactive()"></bb-avatar>\n                <div class="element-details">\n                  <div class="name ellipsis">\n                      <bb-username user="user" format="short" auto-update="::autoUpdate" show-pronouns="true" ng-class="{ inactive: inactive() }"></bb-username>\n                  </div>\n                  <div class="content ellipsis">\n                    <p class="user-name js-course-role" bb-translate>{{bbUsercard.getCourseRoleLocalizeId()}}</p>\n                  </div>\n                </div>\n            </span>\n        </div>\n        <div ng-if="showcard" bb-click-outside="bbUsercard.hide()" is-active="showcard"\n             role="region" aria-label="{{bbUsercard.getUserNameLabel()}}"\n             class="element-card usercard usercard-not-clickable" ng-class="{\'showcard\': showcard }" bb-focus>\n            <div class="header">\n                <bb-avatar user="user" ng-attr-auto-update="::autoUpdate" inactive="inactive()"></bb-avatar>\n                <div class="element-details">\n                    <div class="name">\n                        <bb-username class="name-title" user="user" ng-class="{ inactive: inactive() }" show-pronouns="true"\n                                     ng-attr-format="{{attr.format}}" ng-attr-auto-update="{{::autoUpdate}}"></bb-username>\n                    </div>\n                  <div class="userId ellipse" ng-if="user.userName && !user.studentId" title="{{user.userName}}">{{user.userName}}</div>\n                  <div class="userId ellipse" ng-if="!user.userName && user.studentId" bb-translate translate-values="{ studentId: user.studentId }">components.directives.usercard.studentId</div>\n                  <div class="userId ellipse" ng-if="user.userName && user.studentId" bb-translate translate-values="{ username: user.userName, studentId: user.studentId }">components.directives.usercard.usernameAndId</div>\n                  <div class="profile ellipsis" bb-translate>{{bbUsercard.getCourseRoleLocalizeId()}}</div>\n                    <div class="profile exception-link" ng-if="bbUsercard.hasDueDateException()">\n                      <div class="clickable ellipsis" ng-if="bbUsercard.canEditDueDateException()" bb-translate bb-peek-sref="accommodation({membershipId: membershipId})">\n                        components.directives.usercard.studentExceptions\n                      </div>\n                      <span ng-if="!bbUsercard.canEditDueDateException()" bb-translate>\n                        components.directives.usercard.studentExceptions\n                      </span>\n                    </div>\n                </div>\n            </div>\n            <div class="buttons">\n              \x3c!-- I don\'t use one time binding, as user can open a peek panel to config this attribute. This configuration has to take effect immediately--\x3e\n              <button aria-hidden="{{!showcard}}" ng-if="bbUsercard.canSendMessage()"\n                      type="button"\n                      ng-click="bbUsercard.sendMessage()"\n                      class="button large clear mail-button"\n                      title="{{user.mail}}"\n                      bb-translate-attrs="{\'aria-label\': \'components.directives.usercard.sendMessage\'}"\n                      tabindex="{{showcard ? 0 : -1}}"\n                      ng-keydown="bbUsercard.sendMessageViaSpaceBar($event)"\n                      analytics-id="components.directives.usercard.sendMessage.button"\n              >\n                <bb-svg-icon size="medium" icon="messages"></bb-svg-icon>\n              </button>\n            </div>\n        </div>\n    </div>\n\n</div>\n'},tZxt:function(e,s){e.exports='<div bb-load-bundle="components/directives/discussion"\n  bb-intersection-observer-target intersection-observer-target-id="{{::messageMode === \'view\' ? \'message\' + message.id : \'\'}}"\n                                  in-callback="inCallback()"\n                                  out-callback="outCallback()">\n  <div class="reply-form comments"\n      in-view="messageControl.updateMessageStatus($inview, message)"\n      in-view-options="{ debounce: 2000 }"\n      tabindex="-1"\n      message-id="{{messageMode === \'view\' ? message.id : \'\'}}">\n    <div class="clearfix">\n      <div ng-if="::messageControl.isUserCardShown()" class="element-card discussion-item nocontent">\n        <div class="element-details message-avatar-container"></div>\n        <div class="user-info {{::\'message_user\'+message.user.id}}">\n          <div class="username-wrapper">\n            <span class="user-role-label" bb-translate course-org-token-resolver>course.engagement.conversationView.instructorLabel</span>\n            <h3 ng-class="{ inactive: !messageControl.isAvailable() }">\n              <bb-linked-username\n                analytics-id="discussion.message.user"\n                user="message.user"\n                user-name-styles="!messageControl.canViewUserDetails ? \'username\' : undefined"\n                show-pronouns="true"\n                show-pronunciation="true"\n                on-click="messageControl.authorNameClickHandler()"\n              >\n              </bb-linked-username>\n            </h3>\n            <span ng-if="messageControl.isMessageDrafted()" class="is-draft-label" bb-translate>components.directives.discussion.message.draftLabel</span>\n          </div>\n          <bb-duration date="message.postDate" auto-update="true" has-ago="true"></bb-duration>\n          <i ng-if="messageControl.scope.showDueDate" class="overdue-tip" bb-translate>components.directives.discussion.message.overdue</i>\n          <span ng-if="::messageControl.shouldShowUnreadInfo() && !message.states.readStateInd" class="is-new-label" bb-translate>components.directives.discussion.message.newLabel</span>\n        </div>\n      </div>\n    </div>\n    <div ng-if="::messageControl.isAvatarShown()">\n      <bb-avatar user="::loginUser"></bb-avatar>\n    </div>\n\n    <form name="editorForm">\n      <bb-rich-text-editor\n        ng-if="message.id"\n        name="responseEditor"\n        ng-model="messageControl.messageBody.rawText"\n        editor-placeholder-key="{{placeholderKey}}"\n        is-toolbar-hidden="!isEditorActive"\n        is-disabled="messageMode === \'new\' && isDiscussionEdit && !messageControl.isEditing"\n        is-read-only="messageMode !== \'new\' && !isEditorActive"\n        ng-click="messageControl.onEditorClick()"\n        ng-change="messageControl.onMessageChange()"\n        on-blur="messageControl.onEditorBlur()"\n        on-focus="messageControl.setEditorActive()"\n        on-change="messageControl.onBbRichTextEditorChange"\n        content-market-is-read-only="messageControl.hideContentMarketInEditor()"\n        show-word-count="showWordCount"\n        plugin-options="{attachment: true, contentMarket: true, math: true}"\n        analytics-id="components.directives.discussion.message.onEditorClick">\n      </bb-rich-text-editor>\n    </form>\n    <div class="error-message" role="alert" ng-if="messageControl.inputTooLong">\n      <bb-svg-icon icon="attention" size="small" status="alert"></bb-svg-icon>\n      <span bb-translate>components.directives.message.tooLargeMessage</span>\n    </div>\n    <div\n      class="panel-editor-controls"\n      ng-show="isEditorActive"\n    >\n      <button class="button button--text draft-button"\n          ng-click="messageControl.onSave(true)"\n          ng-blur="messageControl.onEditorBlur()"\n          ng-if="messageControl.isMessageDrafted() && !messageControl.stopActivityAfterDueDate()"\n          ng-disabled="messageControl.disableSaveDraftButton"\n          bb-translate\n          analytics-id="components.directives.discussion.saveDraftLabel">\n          components.directives.discussion.saveDraftLabel\n      </button>\n      <button class="button button--secondary js-secondary-button js-text-editor-cancel"\n          ng-click="messageControl.onCancel()"\n          ng-blur="messageControl.onEditorBlur()"\n          bb-translate\n          analytics-id="components.directives.discussion.cancelLabel">\n        components.directives.discussion.cancelLabel\n      </button>\n      <button class="button js-primary-button js-text-editor-save"\n          ng-click="messageControl.onSave()"\n          ng-blur="messageControl.onEditorBlur()"\n          ng-disabled="messageControl.disableSaveButton"\n          bb-translate\n          analytics-id="{{ messageControl.saveButtonLabelKey }}">\n        {{ messageControl.saveButtonLabelKey }}\n      </button>\n    </div>\n\n    <div ng-if="messageControl.shouldShowOverflowMenu()" class="content-item-controls overflow-menu-container" bb-foundation-defer>\n      <bb-overflow-menu ng-if="messageControl.overflowMenus"\n                        ng-hide="messageControl.isReadOnly()"\n                        element-id="{{\'comment-field\' + message.id}}"\n                        menu-items="messageControl.overflowMenus"\n                        element-name="{{messageControl.getMoreOptionsLabel(message.user.givenName, message.user.familyName, message.postDate)}}"\n                        analytics-id-tag-prefix="{{analyticsIdTagPrefix}}.message">\n      </bb-overflow-menu>\n    </div>\n\n    <div ng-if="messageControl.isContentFixed()" class="content">\n      <div class="controls">\n        <button class="button icon medium super-clear text-editor-delete" ng-if="messageControl.showDeleteButton()"\n                type="button"\n                ng-click="messageControl.onDelete()"\n                bb-confirmation-needed="{{ deleteConfirmHandler }}"\n                choices="{{ messageControl.getChoices() }}"\n                show-type="{{modalShowType}}"\n                aria-label="{{messageControl.getDeleteLabel()}}"\n                analytics-id="components.directives.discussion.message.delete.button">\n          <bb-svg-icon icon="trash" size="medium"></bb-svg-icon>\n        </button>\n      </div>\n    </div>\n    <div class="edited-by" ng-if="!messageControl.isMessageDrafted() && (message.lastUpdateUser && message.editDate && messageMode !== \'new\')"\n         ng-switch="message.lifecycle.toString() !== \'DELETED\'">\n      <div ng-switch-when="true" class="edit-info" bb-translate translate-values="{user: messageControl.lastUpdateUsername, editDate: message.editDate}">\n        components.directives.discussion.message.lastUpdateInfo\n      </div>\n      <div ng-switch-when="false" class="edit-info" bb-translate translate-values="{user: messageControl.lastUpdateUsername, editDate: message.editDate}">\n        components.directives.discussion.message.lastDeleteInfo\n      </div>\n    </div>\n  </div>\n</div>\n'},x8kk:function(e,s,t){"use strict";(function(e){t.d(s,"f",(function(){return A})),t.d(s,"e",(function(){return U})),t.d(s,"a",(function(){return P})),t.d(s,"b",(function(){return B})),t.d(s,"c",(function(){return N})),t.d(s,"d",(function(){return R}));var i=t("D57K"),o=(t("k6nO"),t("nsO7")),a=t("Llzl"),n=t("oVrE"),r=t("jbaE"),c=t("Fvsw"),l=t("Sgjf"),d=t("Ox3N"),u=t("lmMM"),h=t("r133"),p=t("0JpG"),m=t("pjml"),g=t("JNtI"),b=t("lEL+"),v=t("gCXj"),y=t("jmkQ"),f=t("OsJo"),w=t("ZzYr"),S=t("e9p2"),C=t("TnpK"),I=t("g7Mf"),E=t("Qbdf"),O=t("tZxt"),D=t("pSe1"),$=t("ZzR9"),M=t("aHpC"),x=t("jhBu"),L=t("5RJJ"),k=t("ZQFV"),j=t("nmzr"),T=t("PSJS");const A="ultra.directives.discussion.message",U="update-discussion-message",P="add-discussion-message",B="delete-discussion-message",N="update-grade-status",R="update-indicator-status";var V;!function(e){e.NewMode="new",e.ViewMode="view"}(V||(V={}));let F=class{constructor(e,s,t,i,a,n,r,c,l,d,h,p,m,g){var b;this.scope=e,this.$q=t,this.element=i,this.bbContext=a,this.bbLocalize=n,this.timeout=r,this.UserModel=c,this.ultraState=l,this.discussionService=h,this.courseMembershipService=m,this.$sce=g,this.isEditing=!1,this.requestIsLoading=!1,this.inputTooLong=!1,this.groupIdParam={},this.readOnlyState=!0,this.keepEditorActive=!1,this.canViewUserDetails=!1,this.hideContentMarketInEditor=()=>!1,this.onBbRichTextEditorChange=e=>{this.toBbML=e},this.getMoreOptionsLabel=o.memoize(((e,s,t)=>this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.discussion.moreOptionsLabel",params:{postDate:t,user:{givenName:e,familyName:s}},noWrap:!0,noEscape:!0})),((e,s,t)=>String(e)+String(s)+String(t))),this.authorNameClickHandler=()=>{if(this.canViewUserDetails)return this.onAuthorNameClick},this.onAuthorNameClick=()=>{const e=this.scope.courseId,s=this.scope.message.user.id;return this.courseMembershipService.getMembershipByUserId(e,s).then((t=>Object(j.ab)(e,s,t))).then((e=>this.ultraState.goPeekState(e.routeName,e.getArgs())))},this.scope.courseId=null!==(b=d.courseId)&&void 0!==b?b:l.params.courseId,p.hasCourseEntitlement(k.q.ViewGrades,this.scope.courseId).then((e=>this.canViewUserDetails=e)),this.originalText="",e.inputText&&(this.originalText=e.inputText,this.inputTextSafe=g.trustAsHtml(e.inputText.replace(/(.|\s*)(<a )(.|\s*)/g,'$1<a target="_blank" rel="noopener noreferrer" $3'))),V.NewMode===this.scope.messageMode?this.messageBody={rawText:"",displayText:""}:this.messageBody=this.scope.message&&this.scope.message.body||{rawText:"",displayText:""},this.toBbML=S.a.generateToBbML(this.messageBody.rawText),this.choices=[],!this.scope.message.lastUpdateUser&&this.isAnonymousContentEdited()&&(this.scope.message.lastUpdateUser=this.scope.message.user),this.updateLocalizedLastUpdateUserName(),this.overflowMenus=this.getOverflowMenus(),e.$watch("isDeleteAllDisabled",(()=>{e.showDeleteAll&&(this.choices.splice(0),this.choices.push({key:"delete-all-replies",value:e.isDeleteAllDisabled,localizedKey:u.c(e.deleteConfirmHandler.replace(/^resource\//,""),"delete-all-replies"),isDisable:e.isDeleteAllDisabled}))})),e.$watch("message.lastUpdateUser",(()=>{this.updateLocalizedLastUpdateUserName()})),e.$on($.b.$stateChangeStart,((e,s)=>{this.keepEditorActive&&(this.keepEditorActive=!1),s.name.includes("peek.content-market")&&(this.keepEditorActive=!0)})),e.$watch("message.body.rawText",(e=>{e&&(V.ViewMode===this.scope.messageMode&&(this.messageBody={rawText:e,displayText:""}),this.inputTextSafe=this.$sce.trustAsHtml(this.scope.message.body.rawText.replace(/(.|\s*)(<a )(.|\s*)/g,'$1<a target="_blank" rel="noopener noreferrer" $3')))})),e.$on("SET_MESSAGE_ACTIVE",((e,s)=>{this.scope.message.id===s&&this.edit()}))}isUserCardShown(){return V.ViewMode===this.scope.messageMode}canSendMessageInUserCard(){return!n.d(this.scope.message.user)&&this.isCourseActive()&&this.isAvailable()}isAvatarShown(){return V.NewMode===this.scope.messageMode&&this.scope.showAvatarOnNew&&this.scope.showAvatarOnNew()}isEditingAreaShown(){return this.isEditing}isDeleteButtonShown(){return this.scope.message&&this.scope.message.permissions&&m.v.MessageLifeCycleEnum.Deleted!==this.scope.message.lifecycle&&(this.scope.message.permissions.delete||this.scope.message.permissions.edit)&&!this.isEditing&&!this.scope.isDiscussionEdit}isEditButtonShown(){return!(this.scope.isEditDisabled&&this.scope.isEditDisabled())&&this.scope.message&&this.scope.message.permissions&&m.v.MessageLifeCycleEnum.Deleted!==this.scope.message.lifecycle&&this.scope.message.permissions.edit&&(!this.scope.isDiscussionEdit||this.isEditing)}isMessageDrafted(){return!(!this.scope.enableDraft||"new"!==this.scope.messageMode)||this.scope.enableDraft&&this.scope.message&&this.scope.message.id&&!this.scope.message.permissions.reply&&m.v.MessageLifeCycleEnum.Drafted===this.scope.message.lifecycle}onMessageChange(){this.scope.enforceLengthLimit&&(this.inputTooLong=S.a.isMessageTooLong(this.messageBody.rawText))}get saveButtonLabelKey(){return this.isMessageDrafted()&&this.scope.saveButtonDraftLabelKey?this.scope.saveButtonDraftLabelKey:this.scope.saveButtonLabelKey}get disableSaveButton(){var e,s;return V.NewMode===this.scope.messageMode&&(null===(e=this.scope.editorForm.responseEditor)||void 0===e?void 0:e.$pristine)||this.inputTooLong||(null===(s=this.discussionService)||void 0===s?void 0:s.stopActivityAfterDueDate())}get disableSaveDraftButton(){var e;return(null===(e=this.scope.editorForm.responseEditor)||void 0===e?void 0:e.$pristine)||this.inputTooLong}isView(){return V.ViewMode===this.scope.messageMode}showEditButton(){return!this.scope.hideButtons&&(this.isView()&&this.isEditButtonShown())}showDeleteButton(){return!this.requestIsLoading&&(!this.scope.hideButtons&&(this.isView()&&this.isDeleteButtonShown()))}setEditorActive(){this.scope.isDiscussionEdit||this.scope.isEditorActive||(this.scope.$emit("isCurrentDiscussionEditingChanged",!0),this.isEditing=!0,this.scope.isEditorActive=!0,this.scope.editorForm.responseEditor.$setPristine())}onEditorBlur(){var e;const s=this.element.find("button:focus").length>0;!this.disableSaveButton||s||this.inputTooLong||this.keepEditorActive||(null===(e=this.discussionService)||void 0===e?void 0:e.stopActivityAfterDueDate())||this.setEditorInactive()}setEditorInactive(){this.scope.$emit("isCurrentDiscussionEditingChanged",!1),this.isEditing=!1,this.scope.isEditorActive=!1}onCancel(){this.resetEditingFlag(),this.inputTooLong=!1,this.messageBody={rawText:this.originalText,displayText:this.originalText},this.scope.onCancelFunc&&this.scope.onCancelFunc(),this.scope.inputText=this.originalText}resetEditingFlag(){this.setEditorInactive(),this.disableEditState()}onSave(e){this.resetEditingFlag(),this.toBbML(!0).then((s=>{this.stopActivityAfterDueDate()?this.messageBody.rawText=this.originalText:this.messageBody.rawText=s,this.scope.onSaveFunc&&this.scope.onSaveFunc({value:this.messageBody.rawText}),V.NewMode===this.scope.messageMode?(this.onSaveNew(e),this.timeout((()=>{this.messageBody={rawText:"",displayText:""},this.scope.inputText=""}),this.scope,0)):this.onSaveEdit(e),this.scope.editorForm.responseEditor.$setPristine()}))}onSaveNew(e){const s=this.scope.message.replies.$build();return s.parentId=this.scope.message.id,s.courseId=this.scope.message.courseId,s.forumId=this.scope.message.forumId,s.userId=this.scope.loginUser.id,s.lifecycle=e?m.v.MessageLifeCycleEnum.Drafted:m.v.MessageLifeCycleEnum.Published,s.postedName=this.scope.loginUser.givenName+" "+this.scope.loginUser.familyName,s.subject=null,s.body=this.messageBody,s.isDeleted=!1,s.postDate=this.bbContext.getServerTime(),s.editDate=this.bbContext.getServerTime(),this.scope.message.ui.showAllReplies=!0,this.groupIdParam=this.scope.getGroupId&&this.scope.getGroupId()?{groupId:this.scope.getGroupId()}:{},this.scope.message.saveReply(s,this.groupIdParam).$then((s=>{let t;if(s.states.readStateInd=!0,this.scope.message.ui.replies||(this.scope.message.ui.replies=[]),s.user=this.scope.loginUser,s.parent=this.scope.message,s.ui.replies=s.replies,m.v.MessageType.ClassConversation===this.scope.message.type?s.type=m.v.MessageType.Comment:s.type=Object(T.nextMessageType)(this.scope.message.type),this.scope.isRepliesOrderByDesc){const s=o.findIndex(this.scope.message.ui.replies,(e=>m.v.MessageLifeCycleEnum.Drafted!==e.lifecycle));t=e?0:s>-1?s:this.scope.message.ui.replies.length}else{let s=o.findLastIndex(this.scope.message.ui.replies,(e=>m.v.MessageLifeCycleEnum.Drafted!==e.lifecycle));e?t=this.scope.message.ui.replies.length:s>-1?(s+=1,t=s):t=0}this.scope.message.ui.replies.splice(t,0,s),this.scope.message.ui.count++,this.scope.message.messageStatus.numberOfChildren++,this.scope.message.messageStatus.numberOfReadChildren++,this.scope.message.parent&&(this.scope.message.parent.messageStatus.numberOfChildren++,this.scope.message.parent.messageStatus.numberOfReadChildren++),this.scope.$emit(P,m.v.MessageType.Discussion===this.scope.message.type,s.id,e),this.scope.$root.$broadcast(N)}))}onSaveEdit(e){this.groupIdParam=this.scope.getGroupId&&this.scope.getGroupId()?{groupId:this.scope.getGroupId()}:{},this.scope.message.body=this.messageBody;const s=!e&&m.v.MessageLifeCycleEnum.Drafted===this.scope.message.lifecycle;(m.v.MessageLifeCycleEnum.Published!==this.scope.message.lifecycle||e)&&(this.scope.message.lifecycle=e?m.v.MessageLifeCycleEnum.Drafted:m.v.MessageLifeCycleEnum.Published),this.scope.message.withParams(this.groupIdParam).$patch().$then((()=>{this.scope.inputText=this.scope.message.body.rawText,this.messageBody=this.scope.message.body,this.originalText=this.scope.inputText,this.scope.message.editDate=this.bbContext.getServerTime(),this.scope.message.postAsAnonymous?this.scope.message.lastUpdateUser=this.getAnonymousUpdateUser():this.scope.message.lastUpdateUser=s?null:this.scope.loginUser,this.scope.$emit(U,m.v.MessageType.Comment===this.scope.message.type,this.scope.message.id,this.scope.message,!1,s)})),this.isEditing=!1}isCascadeDelete(){return this.scope.shouldDeleteAll||this.scope.isDeleteAllDisabled}onDelete(){if(this.requestIsLoading=!0,this.scope.onDeleteFunc)return this.scope.onDeleteFunc();this.groupIdParam=this.scope.getGroupId&&this.scope.getGroupId()?{groupId:this.scope.getGroupId()}:{};const e=m.v.MessageType.Comment===this.scope.message.type;if(this.isCascadeDelete())return this.scope.message.withParams({cascade:!0,...this.groupIdParam}).$destroy().$asPromise().then((()=>{this.scope.message.parent&&(o.remove(this.scope.message.parent.ui.replies,{id:this.scope.message.id}),this.scope.message.parent.parent&&(this.scope.message.parent.parent.messageStatus.numberOfChildren-=1),this.scope.message.parent.messageStatus.numberOfChildren-=this.scope.message.messageStatus.numberOfChildren+1),this.scope.$root.$broadcast(B,e,this.scope.message.id,this.scope.message),this.scope.$root.$broadcast(N)}));const s=this.scope.message.parent?o.findIndex(this.scope.message.parent.ui.replies,{id:this.scope.message.id}):void 0;return this.scope.message.withParams({cascade:!1,...this.groupIdParam}).$destroy().$asPromise().then((()=>{this.scope.message.lifecycle=m.v.MessageLifeCycleEnum.Deleted,this.scope.message.editDate=new Date,this.scope.message.permissions.edit=!1,this.scope.message.lastUpdateUser=this.getAnonymousUpdateUser(),this.updateLocalizedLastUpdateUserName(),this.scope.message.parent&&-1===o.findIndex(this.scope.message.parent.ui.replies,["id",this.scope.message.id])&&this.scope.message.parent.ui.replies.splice(s,0,this.scope.message),this.scope.$emit(U,e,this.scope.message.id,this.scope.message,!0),this.scope.$root.$broadcast(N)}))}getAnonymousUpdateUser(){return this.scope.message.lastUpdateUserId===this.scope.loginUser.id?this.scope.loginUser:this.scope.message.user}getDeleteLabel(){const e=this.element.find(".js-bbml-block").find(" .element-list-row").text().trim();return this.bbLocalize.translateSync({locale:this.bbLocalize.getLocale(this.scope),key:"components.directives.discussion.message.delete",params:{msg:e},noWrap:!0,noEscape:!0})}generateStringByMessage(){if(this.scope.message)return this.scope.message.id+"-commit-edit"}generateFocusStringByMessage(){if(this.scope.message)return m.v.MessageType.Reply===this.scope.message.type?this.scope.message.parent.id+"-commit-edit":this.scope.message.id+"-commit-edit"}isCourseActive(){return!(this.scope.isCourseComplete||this.scope.isCoursePrivate)}getLastUpdateUserName(){if(this.scope.message&&this.scope.message.lastUpdateUser)return this.scope.message.lastUpdateUser.userName}getLastUpdateDate(){if(this.scope.message)return this.scope.message.editDate}isReadOnly(){return this.scope.isEditDisabled&&this.scope.isEditDisabled()||this.scope.hideButtons||!((V.NewMode===this.scope.messageMode||V.ViewMode===this.scope.messageMode&&this.scope.message&&this.scope.message.permissions&&this.scope.message.permissions.edit)&&(!this.scope.isDiscussionEdit||this.isEditing))}updateLocalizedLastUpdateUserName(){this.scope.message&&this.scope.message.lastUpdateUser&&this.bbLocalize.formatUsername(this.scope.message.lastUpdateUser,p.ILocaleUsernameFormat.Short,this.scope,{noWrap:!0,noEscape:!0}).then((e=>{this.lastUpdateUsername=e}))}isAnonymousContentEdited(){return this.scope.message.postAsAnonymous&&null==this.scope.message.lastUpdateUserId&&this.scope.message.postDate&&this.scope.message.editDate&&this.scope.message.postDate.getTime()!==this.scope.message.editDate.getTime()}isContentFixed(){return!!this.requestIsLoading||(!(!this.scope.isEditDisabled||!this.scope.isEditDisabled())||(this.scope.message&&this.scope.message.permissions?V.ViewMode===this.scope.messageMode?!1===this.scope.message.permissions.edit:V.NewMode===this.scope.messageMode?!1===this.scope.message.permissions.reply:void 0:void 0))}isAvailable(){return!this.scope.isCourseAvailable||this.scope.isCourseAvailable()}shouldShowUnreadInfo(){return!(!this.scope.showUnread||!this.scope.showUnread())}updateMessageStatus(e,s){if(this.shouldShowUnreadInfo()&&e&&s&&!s.states.readStateInd){s.states.readStateInd=!0,this.groupIdParam=this.scope.getGroupId&&this.scope.getGroupId()?{groupId:this.scope.getGroupId()}:{},s.updateMessageStatus(s.states,this.groupIdParam),this.scope.$emit(R);const e=s=>{s&&s.parent!==s&&(s.parent.messageStatus.numberOfReadChildren++,e(s.parent))};e(s)}}getOverflowMenus(){const e=[];e.push({labelKey:"global.edit",icon:"draw",show:()=>this.showEditButton(),onClick:this.edit.bind(this)});const s={labelKey:"global.delete",icon:"trash",show:()=>this.showDeleteButton(),onClick:this.onDelete.bind(this)};return this.scope.deleteConfirmHandler&&(s.confirmationOptions={},s.confirmationOptions.lazyLoadTitleKeyAndInstructionsKey=()=>(this.isMessageDrafted()&&(this.scope.deleteConfirmHandler="resource/x-bb-draft"),this.$q.when(g.a(this.scope.deleteConfirmHandler.replace(/^resource\//,"")))),s.confirmationOptions.choices=this.choices),e.push(s),e}shouldShowOverflowMenu(){return!this.stopActivityAfterDueDate()&&(this.showEditButton()||this.showDeleteButton())}stopActivityAfterDueDate(){var e;return null===(e=this.discussionService)||void 0===e?void 0:e.stopActivityAfterDueDate()}clickMessageText(s){if(this.isContentFixed()||!this.readOnlyState||V.NewMode===this.scope.messageMode)return;const t=e(s.target);t.is("button")||t.parent().is("button")||t.is("a")||t.parent().is("a")||this.edit()}onEditorClick(){V.NewMode!==this.scope.messageMode||this.scope.isEditorActive||this.edit()}edit(){this.readOnlyState=!1,this.setEditorActive(),this._focusTextEditor()}isLoginUserOwnedMessage(){return this.scope.message.user&&this.scope.message.user.id===this.scope.loginUser.id}_focusTextEditor(){this.timeout((()=>{this.element.find(".editor-element").first().focus(),this.element.find(".bb-editor").first().focus()}),this.scope,0,!0)}disableEditState(){this.readOnlyState=!0}};F=Object(i.a)([Object(i.c)(0,Object(M.b)("scope")),Object(i.c)(1,Object(M.b)("attrs")),Object(i.c)(2,Object(M.b)("$q")),Object(i.c)(3,Object(M.b)("element")),Object(i.c)(4,Object(M.b)(c.b)),Object(i.c)(5,Object(M.b)(p.serviceName)),Object(i.c)(6,Object(M.b)(b.b)),Object(i.c)(7,Object(M.b)(m.Jb.serviceName)),Object(i.c)(8,Object(M.b)(C.d)),Object(i.c)(9,Object(M.b)(E.e)),Object(i.c)(10,Object(M.b)(I.c)),Object(i.c)(11,Object(M.b)(x.b)),Object(i.c)(12,Object(M.b)(L.b)),Object(i.c)(13,Object(M.b)("$sce"))],F);class G{constructor(e,s){this.$compile=e,this.$injector=s,this.restrict="E",this.template=O,this.scope={placeholderKey:"@",cancelButtonLabelKey:"@?",saveButtonLabelKey:"@?",saveButtonDraftLabelKey:"@?",isLoginUserStudent:"=?",deleteConfirmHandler:"@?",cancelConfirmHandler:"@?",modalShowType:"@?",inputText:"=",loginUser:"=?",messageMode:"@",message:"=",showDeleteAll:"=?",shouldDeleteAll:"=?",isDeleteAllDisabled:"=?",enforceLengthLimit:"<?",focusOn:"@?",focusId:"@?",courseId:"@?",isRepliesOrderByDesc:"@?",isDiscussionEdit:"=?",isCourseComplete:"=?",isCoursePrivate:"=?",isEditDisabled:"&?disableEdit",isConversation:"=?",onDeleteFunc:"&?",onCancelFunc:"&?",onSaveFunc:"&?",plainText:"=?",showAvatarOnNew:"&?",showDueDate:"=?",showUnread:"&?",courseRole:"=?",hideButtons:"=?",getGroupId:"&?groupId",isCourseAvailable:"&?courseAvailable",hideContentMarketButton:"=?",allowEmptyBlock:"=?",enableDraft:"=?",showWordCount:"=?",analyticsIdTagPrefix:"@?"},this.link=(e,s,t)=>{e.messageControl=this.$injector.instantiate(F,{scope:e,element:s,attrs:t}),e.$on("delete-all-replies",((s,t)=>{e.shouldDeleteAll=t})),e.$on("focus",((s,t,i)=>{t.startsWith("comment-reply")&&i===(e.getGroupId&&e.getGroupId())&&V.NewMode===e.messageMode&&e.messageControl.edit()}));const[i]=["message_avatar"];e.inCallback=()=>{f.a.insertElement(e,i,this.messageAvatarLinkFn,s.find(".message-avatar-container"))},e.outCallback=()=>{f.a.removeElement(e,i)}},this.messageAvatarLinkFn=this.$compile(D)}}G.$inject=["$compile","$injector"],a.module(A,["angular-inview",c.a,l.a,d.a,h.a,p.moduleName,m.N,g.b,b.a,r.a,v.a,y.a,w.a,C.b,E.b]).config([v.b+"Provider",function(e){e.onStyleRefresh((function(e,s){e.selector(`bb-message .message_user${s.userId} .overdue-tip`).rule("display",s.isDueDateExcepted()?"none":"inline")}))}]).directive("bbMessage",["$injector",e=>e.instantiate(G)])}).call(this,t("71td"))}}]);